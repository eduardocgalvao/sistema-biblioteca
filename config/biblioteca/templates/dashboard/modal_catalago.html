<!-- templates/dashboard/modal_catalago.html -->

{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/home.css' %}">
{% endblock %}

<div id="bookModal" class="modal-overlay" onclick="closeModal(event)" style="display: none;">
    <div class="modal-content" onclick="event.stopPropagation()" role="document">
        <div class="modal-header">
            <h2 class="modal-title" id="modalBookMainTitle">Carregando...</h2>
            <button class="modal-close" onclick="closeModal(event)" aria-label="Fechar modal">
                &times;
            </button>
        </div>
        
        <div class="modal-body">
            <div class="book-detail-grid">
                <div class="book-detail-cover">
                    <img id="modalBookCover" src="" alt="Capa do livro" loading="lazy" 
                         onerror="this.onerror=null; this.src='{% static 'images/default-cover.png' %}';">
                </div>
                
                <div class="book-detail-info">
                    <!-- Informa√ß√µes principais -->
                    <div class="detail-row">
                        <span class="detail-label">üìö T√≠tulo:</span>
                        <span class="detail-value" id="modalBookTitleText"></span>
                    </div>
                    
                    <div class="detail-row">
                        <span class="detail-label">üë§ Autor(es):</span>
                        <span class="detail-value" id="modalBookAuthors"></span>
                    </div>
                    
                    <div class="detail-row">
                        <span class="detail-label">üè¢ Editora:</span>
                        <span class="detail-value" id="modalBookPublisher"></span>
                    </div>
                    
                    <div class="detail-row">
                        <span class="detail-label">üè∑Ô∏è Categoria(s):</span>
                        <span class="detail-value" id="modalBookCategories"></span>
                    </div>
                    
                    <!-- Estoque e disponibilidade -->
                    <div class="detail-row">
                        <span class="detail-label">üî¢ ISBN:</span>
                        <span class="detail-value" id="modalBookISBN"></span>
                    </div>
                    
                    <div class="detail-row">
                        <span class="detail-label">üìÖ Ano de Publica√ß√£o:</span>
                        <span class="detail-value" id="modalBookYear"></span>
                    </div>
                    
                    <div class="detail-row">
                        <span class="detail-label">üì¶ Estoque Total:</span>
                        <span class="detail-value" id="modalBookQuantity">
                            <span id="modalBookQuantityValue">0</span>
                            <span class="quantity-indicator" id="modalBookQuantityIndicator"></span>
                        </span>
                    </div>
                    
                    <div class="detail-row">
                        <span class="detail-label">üìä Dispon√≠vel para Empr√©stimo:</span>
                        <span class="detail-value" id="modalBookAvailable">
                            <span id="modalBookAvailableValue">0</span>
                            <span class="availability-indicator" id="modalBookAvailabilityIndicator"></span>
                        </span>
                    </div>
                    
                    <!-- Status din√¢mico -->
                    <div class="detail-row">
                        <span class="detail-label">üìà Status:</span>
                        <span class="detail-value">
                            <span class="status-badge" id="modalBookStatus"></span>
                        </span>
                    </div>
                    
                    <!-- Datas -->
                    <div class="detail-row">
                        <span class="detail-label">üìÖ Cadastrado em:</span>
                        <span class="detail-value" id="modalBookCreated"></span>
                    </div>
                    
                    <!-- Descri√ß√£o -->
                    <div class="detail-row full-width">
                        <span class="detail-label">üìù Sinopse/Descri√ß√£o:</span>
                        <div class="detail-value book-description" id="modalBookDescription"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Vari√°veis globais
let livroAtualId = null;
let livroAtualTitulo = '';
let livroAtualDisponivel = 0;

// Fun√ß√£o para abrir modal de detalhes
window.openBookModal = function(livroId) {
    console.log('Abrindo modal para livro ID:', livroId);

    // Verificar se o modal existe
    const modal = document.getElementById('bookModal');
    if (!modal) {
        console.error('ERRO: Modal n√£o encontrado!');
        alert('Erro: Modal n√£o dispon√≠vel');
        return;
    }
    
    livroAtualId = livroId;

    // URL
    fetch(`/api/livro/${livroId}/`)
        .then(response => {
            if (!response.ok) {
                throw new Error('Erro na requisi√ß√£o: ' + response.status);
            }
            return response.json();
        })
        .then(data => {
            console.log('Dados recebidos do livro:', data);
            
            // Verificar se tem dt_atualizacao
            console.log('Data de atualiza√ß√£o recebida:', data.dt_atualizacao);
            console.log('Todos os campos recebidos:', Object.keys(data));
            
            // Preencher campos do modal com dados REAIS do banco
            preencherCamposModal(data);
            
            // Atualizar vari√°veis globais
            livroAtualTitulo = data.titulo;
            livroAtualDisponivel = data.disponivel || 0;
            
            // Configurar bot√µes de a√ß√£o
            configurarBotoesAcao(data);
            
            // Mostrar modal
            document.getElementById('bookModal').style.display = 'flex';
            
            // DEBUG: Verificar se os elementos foram preenchidos
            setTimeout(() => {
                console.log('Elemento modalBookUpdated ap√≥s preenchimento:', 
                    document.getElementById('modalBookUpdated'));
                console.log('Conte√∫do de modalBookUpdated:', 
                    document.getElementById('modalBookUpdated')?.textContent);
            }, 100);
        })
        .catch(error => {
            console.error('Erro ao carregar livro:', error);
            mostrarErroModal('Erro ao carregar dados do livro. Tente novamente.');
        });
};

// Fun√ß√£o para preencher campos do modal com dados reais
function preencherCamposModal(data) {
    // DEBUG: Log inicial
    console.log('Preenchendo modal com dados:', data);

    // Informa√ß√µes principais
    document.getElementById('modalBookMainTitle').textContent = data.titulo || 'T√≠tulo n√£o informado';
    document.getElementById('modalBookTitleText').textContent = data.titulo || 'T√≠tulo n√£o informado';
    document.getElementById('modalBookAuthors').textContent = data.autores || 'Autor n√£o informado';
    document.getElementById('modalBookPublisher').textContent = data.editora || 'Editora n√£o informada';
    document.getElementById('modalBookCategories').textContent = data.categorias || 'Categoria n√£o informada';
    
    // Estoque e disponibilidade (VALORES REAIS DO BANCO)
    document.getElementById('modalBookISBN').textContent = data.isbn || 'ISBN n√£o informado';
    document.getElementById('modalBookYear').textContent = data.ano_publicacao || 'Ano n√£o informado';
    
    // Quantidade em estoque (valor REAL)
    const quantidade = data.quantidade || 0;
    document.getElementById('modalBookQuantityValue').textContent = quantidade;
    
    // Dispon√≠vel para empr√©stimo (valor REAL calculado)
    const disponivel = data.disponivel || 0;
    document.getElementById('modalBookAvailableValue').textContent = disponivel;
    
    // Status do livro (REAL do banco)
    const status = data.status || 'N√£o informado';
    const statusElement = document.getElementById('modalBookStatus');
    if (statusElement) {
        statusElement.textContent = status;
        statusElement.className = 'status-badge ' + getStatusClass(status);
    }
    
    // Datas: usar nomes corretos do JSON
    const createdElement = document.getElementById('modalBookCreated');
    const updatedElement = document.getElementById('modalBookUpdated');
    
    if (createdElement) {
        createdElement.textContent = data.dt_criacao || 'Data n√£o informada';
        console.log('modalBookCreated preenchido:', data.dt_criacao);
    }
    
    if (updatedElement) {
        updatedElement.textContent = data.dt_atualizacao || 'Data n√£o informada';
        console.log('modalBookUpdated preenchido:', data.dt_atualizacao);
        
        // For√ßar repaint (solu√ß√£o para renderiza√ß√£o)
        updatedElement.style.display = 'none';
        updatedElement.offsetHeight; // Trigger reflow
        updatedElement.style.display = '';
    } else {
        console.error('ERRO: Elemento modalBookUpdated n√£o encontrado no DOM!');
    }
    
    // DEBUG para verificar se os campos est√£o sendo preenchidos
    console.log('Data cria√ß√£o:', data.dt_criacao);
    console.log('Data atualiza√ß√£o:', data.dt_atualizacao);
    
    // Descri√ß√£o
    const descriptionElement = document.getElementById('modalBookDescription');
    if (descriptionElement) {
        descriptionElement.textContent = 
            data.descricao || 'Descri√ß√£o n√£o dispon√≠vel para este livro.';
    }
    
    // Capa do livro
    const imgElement = document.getElementById('modalBookCover');
    if (imgElement) {
        if (data.capa_url) {
            imgElement.src = data.capa_url;
            imgElement.alt = `Capa de ${data.titulo}`;
        } else {
            imgElement.src = "{% static 'images/default-cover.png' %}";
            imgElement.alt = "Capa padr√£o";
        }
    }
    
    // Atualizar indicadores visuais
    atualizarIndicadores(quantidade, disponivel);
}

// Fun√ß√£o para atualizar indicadores visuais de estoque
function atualizarIndicadores(quantidade, disponivel) {
    const quantidadeIndicator = document.getElementById('modalBookQuantityIndicator');
    const disponivelIndicator = document.getElementById('modalBookAvailabilityIndicator');
    
    if (quantidadeIndicator) {
        // Indicador de quantidade total
        if (quantidade <= 0) {
            quantidadeIndicator.textContent = ' (ESGOTADO)';
            quantidadeIndicator.className = 'quantity-indicator esgotado';
        } else if (quantidade <= 3) {
            quantidadeIndicator.textContent = ' (BAIXO ESTOQUE)';
            quantidadeIndicator.className = 'quantity-indicator baixo';
        } else if (quantidade <= 10) {
            quantidadeIndicator.textContent = ' (ESTOQUE M√âDIO)';
            quantidadeIndicator.className = 'quantity-indicator medio';
        } else {
            quantidadeIndicator.textContent = ' (ESTOQUE SUFICIENTE)';
            quantidadeIndicator.className = 'quantity-indicator suficiente';
        }
    }
    
    if (disponivelIndicator) {
        // Indicador de disponibilidade
        if (disponivel <= 0) {
            disponivelIndicator.textContent = ' (INDISPON√çVEL)';
            disponivelIndicator.className = 'availability-indicator indisponivel';
        } else if (disponivel <= 3) {
            disponivelIndicator.textContent = ' (POUCAS UNIDADES)';
            disponivelIndicator.className = 'availability-indicator poucas';
        } else {
            disponivelIndicator.textContent = ' (DISPON√çVEL)';
            disponivelIndicator.className = 'availability-indicator disponivel';
        }
    }
}

// Fun√ß√£o para obter classe CSS baseada no status
function getStatusClass(status) {
    if (!status) return 'status-default';
    const statusLower = status.toLowerCase();
    if (statusLower.includes('dispon√≠vel')) return 'status-disponivel';
    if (statusLower.includes('indispon√≠vel')) return 'status-indisponivel';
    if (statusLower.includes('emprestado')) return 'status-emprestado';
    if (statusLower.includes('reservado')) return 'status-reservado';
    if (statusLower.includes('manuten√ß√£o')) return 'status-manutencao';
    return 'status-default';
}

// Fun√ß√£o para configurar bot√µes de a√ß√£o
function configurarBotoesAcao(data) {
    const btnEmprestar = document.getElementById('btnEmprestar');
    const btnEditar = document.getElementById('btnEditar');
    const btnExcluir = document.getElementById('btnExcluir');
    
    // Configurar bot√£o de empr√©stimo
    if (btnEmprestar) {
        const disponivel = data.disponivel || 0;
        if (disponivel > 0) {
            btnEmprestar.disabled = false;
            btnEmprestar.innerHTML = 'üì• Emprestar Livro';
            btnEmprestar.className = 'btn btn-success';
            btnEmprestar.onclick = function() { iniciarEmprestimo(data.id, data.titulo, disponivel); };
        } else {
            btnEmprestar.disabled = true;
            btnEmprestar.innerHTML = 'üì¶ Indispon√≠vel no momento';
            btnEmprestar.className = 'btn btn-secondary';
            btnEmprestar.onclick = null;
        }
    }
    
    // Configurar bot√µes de edi√ß√£o/exclus√£o (apenas para staff)
    if (btnEditar) {
        btnEditar.onclick = function() { editarLivroModal(data.id); };
    }
    
    if (btnExcluir) {
        btnExcluir.onclick = function() { excluirLivroModal(data.id, data.titulo); };
    }
}

// Fun√ß√£o para iniciar processo de empr√©stimo
function iniciarEmprestimo(livroId, titulo, disponivel) {
    const confirmLoanTitle = document.getElementById('confirmLoanTitle');
    const confirmLoanMessage = document.getElementById('confirmLoanMessage');
    const confirmLoanModal = document.getElementById('confirmLoanModal');
    
    if (confirmLoanTitle && confirmLoanMessage && confirmLoanModal) {
        confirmLoanTitle.textContent = titulo;
        confirmLoanMessage.innerHTML = `
            Deseja emprestar o livro <strong>"${titulo}"</strong>?<br>
            <small>Unidades dispon√≠veis: ${disponivel}</small>
        `;
        confirmLoanModal.style.display = 'flex';
    }
}

// Fun√ß√£o para confirmar empr√©stimo
function confirmarEmprestimo() {
    if (!livroAtualId) return;
    
    // Redirecionar para p√°gina de empr√©stimo
    window.location.href = `/emprestimos/novo/?livro=${livroAtualId}`;
}

// Fun√ß√£o para fechar modal de confirma√ß√£o de empr√©stimo
function fecharConfirmLoanModal() {
    const confirmLoanModal = document.getElementById('confirmLoanModal');
    if (confirmLoanModal) {
        confirmLoanModal.style.display = 'none';
    }
}

// Fun√ß√£o para editar livro
function editarLivroModal(livroId) {
    if (!livroId) livroId = livroAtualId;
    window.location.href = `/livros/${livroId}/editar/`;
}

// Fun√ß√£o para excluir livro
function excluirLivroModal(livroId, titulo) {
    if (!livroId) livroId = livroAtualId;
    if (!titulo) titulo = livroAtualTitulo;
    
    if (confirm(`Tem certeza que deseja excluir o livro "${titulo}"?\n\nEsta a√ß√£o n√£o pode ser desfeita.`)) {
        fetch(`/api/livro/${livroId}/delete/`, {
            method: 'DELETE',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                closeModal();
                location.reload();
            } else {
                alert('Erro: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Erro:', error);
            alert('Erro ao excluir livro');
        });
    }
}

// Fun√ß√£o para mostrar erro no modal
function mostrarErroModal(mensagem) {
    const mainTitle = document.getElementById('modalBookMainTitle');
    const titleText = document.getElementById('modalBookTitleText');
    const modal = document.getElementById('bookModal');
    
    if (mainTitle) mainTitle.textContent = 'Erro';
    if (titleText) titleText.textContent = mensagem;
    if (modal) modal.style.display = 'flex';
}

// Fun√ß√£o para fechar modal
window.closeModal = function(event) {
    if (!event || event.target.classList.contains('modal-overlay') || 
        event.target.classList.contains('modal-close') ||
        (event.target.textContent && event.target.textContent.includes('Fechar'))) {
        const bookModal = document.getElementById('bookModal');
        const confirmLoanModal = document.getElementById('confirmLoanModal');
        
        if (bookModal) bookModal.style.display = 'none';
        if (confirmLoanModal) confirmLoanModal.style.display = 'none';
    }
}

// Helper para pegar cookie CSRF
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Fechar modal com ESC
document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
        closeModal();
    }
});

// Inicializa√ß√£o quando o DOM estiver pronto
document.addEventListener('DOMContentLoaded', function() {
    console.log('Modal de cat√°logo carregado');
    
    // Teste: verificar se elementos existem
    console.log('Elemento modalBookUpdated existe?', document.getElementById('modalBookUpdated'));
    console.log('Elemento bookModal existe?', document.getElementById('bookModal'));
});
</script>