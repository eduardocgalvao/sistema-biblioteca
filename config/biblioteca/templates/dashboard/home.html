<!-- templates/dashboard/home.html -->
{% extends 'base.html' %}
{% load static %}

{% block title %}Cat√°logo de Livros - BookStack{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/home.css' %}">
{% endblock %}

{% block content %}
<div class="page-content">
    <form method="GET" class="search-box" role="search">
        <label for="search-input" class="sr-only">Buscar livros</label>
        <input
            type="text"
            id="search-input"
            name="q"
            placeholder="Procurar por nome do livro, autor, categoria ou ISBN..."
            value="{{ query|default:'' }}"
            autocomplete="off"
            aria-label="Buscar livros"
        />
        <button type="submit" class="sr-only">Buscar</button>
    </form>

    <h1 class="page-title">Cat√°logo de Livros</h1>

    {% if livros_com_relacionados %}
    <section class="books-grid" aria-label="Lista de livros">
        {% for item in livros_com_relacionados %}
            {% with livro=item.livro %}
            <article class="book-card" 
                     onclick="openBookModal('{{ livro.id_livro }}')" 
                     onkeydown="if(event.key === 'Enter' || event.key === ' ') openBookModal('{{ livro.id_livro }}')"
                     data-book-id="{{ livro.id_livro }}"
                     role="button"
                     tabindex="0"
                     aria-label="Ver detalhes de {{ livro.titulo }}"
                     title="Clique para ver detalhes de {{ livro.titulo }}">
                
                <div class="book-cover">
                    {% if livro.capa and livro.capa.url %}
                        <img src="{{ livro.capa.url }}" 
                             alt="Capa de {{ livro.titulo }}" 
                             loading="lazy"
                             onerror="this.src='{% static 'img/placeholder.png' %}'">
                    {% else %}
                        <img src="{% static 'img/placeholder.png' %}" 
                             alt="Capa n√£o dispon√≠vel para {{ livro.titulo }}" 
                             loading="lazy">
                    {% endif %}
                </div>

                <div class="book-info">
                    <h3 class="book-title">{{ livro.titulo }}</h3>

                    <div class="book-meta">
                        {% if item.disponivel > 0 %}
                            <span class="status disponivel" aria-label="Dispon√≠vel">
                                Dispon√≠vel
                            </span>
                        {% else %}
                            <span class="status indisponivel" aria-label="Indispon√≠vel">
                                Indispon√≠vel
                            </span>
                        {% endif %}
                    </div>
                </div>
            </article>
            {% endwith %}
        {% endfor %}
    </section>
    {% else %}
    <div class="no-results" role="alert">
        <p class="no-books">
            üìö Nenhum livro encontrado. 
            {% if query %}Tente outra busca.{% endif %}
        </p>
    </div>
    {% endif %}
</div>

<!-- Modal de Detalhes -->
{% include 'dashboard/modal_catalago.html' %}
{% endblock %}

{% block scripts %}
<script src="{% static 'js/home.js' %}"></script>
<script>
// Fun√ß√µes globais para o modal
function openBookModal(livroId) {
    console.log('Abrindo modal para livro ID:', livroId);
    
    // Buscar dados do livro via AJAX
    fetch(`/api/livro/${livroId}/`)
        .then(response => response.json())
        .then(data => {
            // Preencher modal com os dados
            document.getElementById('modalBookMainTitle').textContent = data.titulo;
            document.getElementById('modalBookTitleText').textContent = data.titulo;
            document.getElementById('modalBookAuthors').textContent = data.autores || 'N√£o informado';
            document.getElementById('modalBookPublisher').textContent = data.editora || 'N√£o informado';
            document.getElementById('modalBookCategories').textContent = data.categorias || 'N√£o informado';
            document.getElementById('modalBookISBN').textContent = data.isbn || 'N√£o informado';
            document.getElementById('modalBookYear').textContent = data.ano_publicacao || 'N√£o informado';
            document.getElementById('modalBookQuantity').textContent = data.quantidade || '0';
            document.getElementById('modalBookAvailable').textContent = data.disponivel || '0';
            document.getElementById('modalBookStatus').textContent = data.status || 'N√£o informado';
            document.getElementById('modalBookCreated').textContent = data.dt_criacao || 'N√£o informado';
            document.getElementById('modalBookDescription').textContent = data.descricao || 'Sem descri√ß√£o';
            
            // Capa
            const coverImg = document.getElementById('modalBookCover');
            if (data.capa_url) {
                coverImg.src = data.capa_url;
                coverImg.alt = `Capa de ${data.titulo}`;
            } else {
                coverImg.src = '{% static "img/placeholder.png" %}';
                coverImg.alt = 'Capa n√£o dispon√≠vel';
            }
            
            // Bot√£o de empr√©stimo
            const emprestarBtn = document.getElementById('btnEmprestar');
            if (emprestarBtn) {
                emprestarBtn.dataset.livroId = livroId;
                emprestarBtn.disabled = !(data.disponivel > 0);
            }
            
            // Mostrar modal
            document.getElementById('bookModal').style.display = 'flex';
        })
        .catch(error => {
            console.error('Erro ao carregar dados do livro:', error);
            alert('N√£o foi poss√≠vel carregar os detalhes do livro.');
        });
}

function closeModal(event) {
    if (event) event.stopPropagation();
    document.getElementById('bookModal').style.display = 'none';
}

function goToLoan() {
    const btn = document.getElementById('btnEmprestar');
    const livroId = btn ? btn.dataset.livroId : null;
    if (livroId) {
        window.location.href = `/emprestimo/criar/${livroId}/`;
    }
}

// Fechar modal com ESC
document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
        closeModal();
    }
});
</script>
{% endblock %}